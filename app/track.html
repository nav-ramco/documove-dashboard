<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documove - Track Your Sale</title>
<link rel="stylesheet" href="../css/design-system.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary, #F7FAFC); color: var(--text-primary, #2D3748); }

.login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bg-primary, #F7FAFC); }
.login-box { background: white; padding: 2.5rem; border-radius: 16px; border: 1px solid var(--border, #E2E8F0); width: 100%; max-width: 420px; }
.login-box h2 { text-align: center; margin-bottom: 0.5rem; font-size: 1.5rem; }
.login-box .subtitle { text-align: center; color: var(--text-secondary, #718096); margin-bottom: 2rem; font-size: 0.9rem; }
.brand-dot { display: inline-block; width: 10px; height: 10px; background: var(--primary, #00D9B5); border-radius: 50%; margin-right: 0.25rem; }
.form-group { margin-bottom: 1.2rem; }
.form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.875rem; }
.form-group input { width: 100%; padding: 0.7rem; border: 1px solid var(--border, #E2E8F0); border-radius: 8px; font-size: 0.95rem; }
.form-group input:focus { outline: none; border-color: var(--primary, #00D9B5); box-shadow: 0 0 0 3px rgba(0,217,181,0.1); }
.btn-login { width: 100%; padding: 0.75rem; background: var(--primary, #00D9B5); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
.btn-login:hover { background: var(--primary-dark, #00BFA0); }
.btn-login:disabled { background: #CBD5E0; cursor: not-allowed; }
.error-msg { color: var(--error, #FC8181); text-align: center; margin-top: 1rem; font-size: 0.85rem; display: none; }

.container { max-width: 900px; margin: 0 auto; padding: 2rem; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border, #E2E8F0); }
.header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
.btn-logout { padding: 0.5rem 1rem; background: white; border: 1px solid var(--border, #E2E8F0); border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
.btn-logout:hover { background: var(--bg-primary, #F7FAFC); }

.property-card { background: white; border-radius: 16px; border: 1px solid var(--border, #E2E8F0); padding: 2rem; margin-bottom: 1.5rem; }
.property-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
.property-header h2 { font-size: 1.25rem; margin-bottom: 0.25rem; }
.property-header .address { color: var(--text-secondary, #718096); font-size: 0.9rem; }
.property-header .price { font-size: 1.5rem; font-weight: 700; color: var(--primary, #00D9B5); }

.progress-section { margin-bottom: 2rem; }
.progress-section h3 { font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary, #718096); }
.progress-bar { height: 8px; background: var(--bg-primary, #F7FAFC); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
.progress-fill { height: 100%; background: var(--primary, #00D9B5); border-radius: 4px; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary, #718096); }

.timeline { position: relative; padding-left: 2rem; }
.timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--border, #E2E8F0); }
.timeline-item { position: relative; padding-bottom: 1.5rem; }
.timeline-item::before { content: ''; position: absolute; left: -2rem; top: 4px; width: 16px; height: 16px; border-radius: 50%; background: var(--border, #E2E8F0); border: 3px solid white; }
.timeline-item.completed::before { background: var(--primary, #00D9B5); }
.timeline-item.current::before { background: var(--warning, #ECC94B); }
.timeline-item h4 { font-size: 0.95rem; margin-bottom: 0.25rem; }
.timeline-item p { font-size: 0.85rem; color: var(--text-secondary, #718096); }

.hidden { display: none !important; }
.empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary, #718096); }
</style>
</head>
<body>

<div id="loginPage" class="login-container">
  <div class="login-box">
    <h2><span class="brand-dot"></span> documove</h2>
    <p class="subtitle">Track your property sale or purchase</p>
    <form id="loginForm">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="you@email.com" required>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password" required>
      </div>
      <button type="submit" class="btn-login" id="loginBtn">Sign In</button>
      <p class="error-msg" id="errorMsg"></p>
    </form>
  </div>
</div>

<div id="dashboardPage" class="hidden">
  <div class="container">
    <div class="header">
      <h1><span class="brand-dot"></span> documove</h1>
      <button class="btn-logout" onclick="handleLogout()">Sign Out</button>
    </div>
    <div id="propertiesList"><div class="empty-state">Loading...</div></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://hvbhmsybnhowczokidnc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2Ymhtc3libmhvd2N6b2tpZG5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjI2NTAsImV4cCI6MjA4NjQ5ODY1MH0.60TDi3r-vRhXwnWXH_JY7e5mKZ9GbaHI14cLYowZReA';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const loginPage = document.getElementById('loginPage');
const dashboardPage = document.getElementById('dashboardPage');
const loginForm = document.getElementById('loginForm');
const loginBtn = document.getElementById('loginBtn');
const errorMsg = document.getElementById('errorMsg');
const propertiesList = document.getElementById('propertiesList');

async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) await showDashboard(session.user);
}
checkSession();

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginBtn.disabled = true;
  loginBtn.textContent = 'Signing in...';
  errorMsg.style.display = 'none';
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: document.getElementById('email').value,
      password: document.getElementById('password').value
    });
    if (error) throw error;
    await showDashboard(data.user);
  } catch (error) {
    errorMsg.textContent = error.message;
    errorMsg.style.display = 'block';
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Sign In';
  }
});

async function showDashboard(user) {
  loginPage.classList.add('hidden');
  dashboardPage.classList.remove('hidden');
  await loadProperties(user.id);
}

async function loadProperties(userId) {
  try {
    const { data: properties, error } = await supabase.from('properties').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    if (!properties || properties.length === 0) {
      propertiesList.innerHTML = '<div class="empty-state"><h3>No Properties</h3><p>No active transactions.</p></div>';
      return;
    }
    propertiesList.innerHTML = properties.map(p => {
      const price = p.price ? new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(p.price) : 'TBC';
      const progress = { 'active': 20, 'on_track': 40, 'awaiting_client': 50, 'exchanged': 80, 'completed': 100 }[p.status] || 10;
      return `<div class="property-card"><div class="property-header"><div><h2>${p.address || 'Property'}</h2><p class="address">${p.postcode || ''}</p></div><div class="price">${price}</div></div><div class="progress-section"><h3>Progress</h3><div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div><div class="progress-label"><span>Started</span><span>${progress}%</span><span>Complete</span></div></div></div>`;
    }).join('');
  } catch (error) {
    propertiesList.innerHTML = '<div class="empty-state"><h3>Error</h3><p>' + error.message + '</p></div>';
  }
}

async function handleLogout() {
  await supabase.auth.signOut();
  dashboardPage.classList.add('hidden');
  loginPage.classList.remove('hidden');
}
</script>
</body>
</html>
